#!/bin/bash

# Random.org API key - set via environment variable
# Get your free API key at https://api.random.org/
if [[ -z "$RANDOM_ORG_API_KEY" ]]; then
  echo "Error: RANDOM_ORG_API_KEY environment variable not set"
  echo "Get your free API key at https://api.random.org/"
  exit 1
fi

UA="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"

# Use argument if provided, otherwise fetch random number
if [[ -n "$1" ]]; then
  if ! [[ "$1" =~ ^[0-9]+$ ]] || [[ "$1" -lt 1 || "$1" -gt 1055 ]]; then
    echo "Error: number must be between 1 and 1055"
    exit 1
  fi
  NUM="$1"
else
  NUM=$(curl -s "https://api.random.org/json-rpc/4/invoke" \
    -H "Content-Type: application/json" \
    -d "{
      \"jsonrpc\": \"2.0\",
      \"method\": \"generateIntegers\",
      \"params\": {
        \"apiKey\": \"$RANDOM_ORG_API_KEY\",
        \"n\": 1,
        \"min\": 1,
        \"max\": 1055
      },
      \"id\": 1
    }" | jq -r '.result.random.data[0]')

  if [[ -z "$NUM" || "$NUM" == "null" ]]; then
    echo "Failed to get random number"
    exit 1
  fi
fi

echo -e "\n\033[1;33m══════════════════════════════════════════════════════════════\033[0m"
echo -e "\033[1;36m                        № $NUM\033[0m"
echo -e "\033[1;33m══════════════════════════════════════════════════════════════\033[0m\n"

extract_quote() {
  local html="$1"
  echo "$html" | grep -oP '(?<=<article id="contenido">).*?(?=</article>)' | \
    sed 's/<[^>]*>//g' | \
    sed "s/^[0-9]*\s*//" | \
    sed 's/&#160;.*//g; s/Este ponto em outro idioma.*//g; s/Documento impresso de.*//g' | \
    sed 's/Temas.*//g' | \
    sed 's/&nbsp;/ /g; s/&mdash;/—/g; s/&ldquo;/"/g; s/&rdquo;/"/g; s/&amp;/\&/g' | \
    perl -MHTML::Entities -pe 'decode_entities($_);' 2>/dev/null || cat | \
    fold -s -w 60
}

# Caminho (max 999)
echo -e "\033[1;32m┌─ CAMINHO ─────────────────────────────────────────────────┐\033[0m"
HTML=$(curl -s -A "$UA" "https://escriva.org/pt-br/camino/$NUM/")
QUOTE=$(extract_quote "$HTML")
if [[ -n "$QUOTE" && ! "$QUOTE" =~ "404" && ${#QUOTE} -gt 5 ]]; then
  echo "$QUOTE" | fold -s -w 60 | while IFS= read -r line; do
    echo -e "\033[0;37m  $line\033[0m"
  done
else
  echo -e "\033[0;90m  (ponto não encontrado)\033[0m"
fi
echo -e "\033[1;32m└───────────────────────────────────────────────────────────┘\033[0m\n"

# Sulco (max 1000)
echo -e "\033[1;34m┌─ SULCO ────────────────────────────────────────────────────┐\033[0m"
HTML=$(curl -s -A "$UA" "https://escriva.org/pt-br/surco/$NUM/")
QUOTE=$(extract_quote "$HTML")
if [[ -n "$QUOTE" && ! "$QUOTE" =~ "404" && ${#QUOTE} -gt 5 ]]; then
  echo "$QUOTE" | fold -s -w 60 | while IFS= read -r line; do
    echo -e "\033[0;37m  $line\033[0m"
  done
else
  echo -e "\033[0;90m  (ponto não encontrado)\033[0m"
fi
echo -e "\033[1;34m└───────────────────────────────────────────────────────────┘\033[0m\n"

# Forja (max 1055)
echo -e "\033[1;35m┌─ FORJA ────────────────────────────────────────────────────┐\033[0m"
HTML=$(curl -s -A "$UA" "https://escriva.org/pt-br/forja/$NUM/")
QUOTE=$(extract_quote "$HTML")
if [[ -n "$QUOTE" && ! "$QUOTE" =~ "404" && ${#QUOTE} -gt 5 ]]; then
  echo "$QUOTE" | fold -s -w 60 | while IFS= read -r line; do
    echo -e "\033[0;37m  $line\033[0m"
  done
else
  echo -e "\033[0;90m  (ponto não encontrado)\033[0m"
fi
echo -e "\033[1;35m└───────────────────────────────────────────────────────────┘\033[0m\n"
